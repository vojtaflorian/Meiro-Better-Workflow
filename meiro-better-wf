// ==UserScript==
// @name         Meiro Better Workflow
// @namespace    http://tampermonkey.net/
// @version      2025-07-16
// @description  Meiro Better Workflow - fixed sort button functionality
// @author       Vojta Florian
// @match        *.meiro.io/*
// @match        *.meiro.io/*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=meiro.io
// @downloadURL  https://raw.githubusercontent.com/vojtaflorian/Meiro-Better-Workflow/refs/heads/main/meiro-better-wf
// @updateURL    https://raw.githubusercontent.com/vojtaflorian/Meiro-Better-Workflow/refs/heads/main/meiro-better-wf
// @grant        none
// ==/UserScript==

(function () {
    'use strict';

    // Global storage for cleanup
    let activeIntervals = [];

    // Cleanup on page unload to prevent memory leaks
    window.addEventListener('beforeunload', () => {
        activeIntervals.forEach(id => clearInterval(id));
        activeIntervals = [];
    });

    //***********************************************************
    // AutomatickÃ© Å™azenÃ­ na seznamech od naposledy editovanÃ½ch
    function clickSortButton() {
        console.log("Meiro Better WF: HledÃ¡m Modified tlaÄÃ­tko...");

        // Najdeme tlaÄÃ­tka obsahujÃ­cÃ­ text "Modified" nebo podobnÃ½
        const allButtons = document.querySelectorAll('button');
        console.log(`Meiro Better WF: Nalezeno ${allButtons.length} tlaÄÃ­tek celkem`);

        // HledÃ¡me tlaÄÃ­tko obsahujÃ­cÃ­ "Modified" v textu
        let targetButton = null;
        const searchTerms = ['modified', 'upraveno', 'zmÄ›nÄ›no', 'modified at'];

        allButtons.forEach((btn, index) => {
            const text = btn.textContent.trim().toLowerCase();
            console.log(`Meiro Better WF: TlaÄÃ­tko ${index}: "${btn.textContent.trim()}"`);

            // Zkontroluj jestli obsahuje hledanÃ½ text
            if (searchTerms.some(term => text.includes(term))) {
                targetButton = btn;
                console.log(`âœ… Meiro Better WF: Nalezeno Å™azÃ­cÃ­ tlaÄÃ­tko: "${btn.textContent.trim()}"`);
            }
        });

        if (targetButton) {
            console.log(`Meiro Better WF: KlikÃ¡m na tlaÄÃ­tko: "${targetButton.textContent.trim()}"`);

            try {
                // PrvnÃ­ klik pro zmÄ›nu Å™azenÃ­
                targetButton.click();
                console.log("Meiro Better WF: PrvnÃ­ klik proveden");

                // DruhÃ½ klik po krÃ¡tkÃ© pauze pro sprÃ¡vnÃ© poÅ™adÃ­ (nejnovÄ›jÅ¡Ã­ nahoÅ™e)
                setTimeout(() => {
                    targetButton.click();
                    console.log("Meiro Better WF: DruhÃ½ klik proveden - Å™azenÃ­ podle nejnovÄ›jÅ¡Ã­ch");
                }, 300);

                return true; // Success, stop searching
            } catch (error) {
                console.error("Meiro Better WF: Chyba pÅ™i klikÃ¡nÃ­:", error);
                return false;
            }
        } else {
            console.log("Meiro Better WF: Modified tlaÄÃ­tko nenalezeno");
            return false; // Continue searching
        }
    }

    // VylepÅ¡enÃ½ observer s opakovanÃ½m hledÃ¡nÃ­m
    function setupSortObserver() {
        let attempts = 0;
        const maxAttempts = 20; // MaximÃ¡lnÄ› 20 pokusÅ¯ (10 sekund)
        let searchInterval;

        function searchForSortButton() {
            attempts++;
            console.log(`Meiro Better WF: Pokus ${attempts}/${maxAttempts} - hledÃ¡m sort tlaÄÃ­tka`);

            const success = clickSortButton();

            if (success) {
                console.log("Meiro Better WF: Sort tlaÄÃ­tko ÃºspÄ›Å¡nÄ› nalezeno a kliknuto");
                clearInterval(searchInterval);
                const index = activeIntervals.indexOf(searchInterval);
                if (index > -1) activeIntervals.splice(index, 1);
            } else if (attempts >= maxAttempts) {
                console.log("Meiro Better WF: MaximÃ¡lnÃ­ poÄet pokusÅ¯ dosaÅ¾en, zastavuji hledÃ¡nÃ­");
                clearInterval(searchInterval);
                const index = activeIntervals.indexOf(searchInterval);
                if (index > -1) activeIntervals.splice(index, 1);
            }
        }

        // ZaÄni hledat po krÃ¡tkÃ©m zpoÅ¾dÄ›nÃ­
        setTimeout(() => {
            searchInterval = setInterval(searchForSortButton, 500);
            activeIntervals.push(searchInterval);

            // PrvnÃ­ pokus ihned
            searchForSortButton();
        }, 1000);
    }

    // SpusÅ¥ setup po naÄtenÃ­ strÃ¡nky
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setupSortObserver);
    } else {
        setupSortObserver();
    }

    //***********************************************************
    // VyplnÄ›nÃ­ Send to a Profile ID dynamicky v Campaigns
    const onCampaignPage = window.location.href.includes("meiro.io/channels/emails/campaigns");
    if (!onCampaignPage) {
        console.log('ðŸ”’ Meiro Better WF: NespouÅ¡tÃ­m ÄÃ¡st pro Send to a Profile ID â€“ URL neodpovÃ­dÃ¡');
    }
    if (onCampaignPage) {
        let userEmail = null;
        const profileIDToFill = "00059461-1b48-f552-3d8c-9f0422f5aef8"; // profil ID pro pÅ™edvyplnÄ›nÃ­ v Campaigns

        function getUserEmail() {
            let userMenu = document.querySelector("[data-testid='user-menu']");
            if (userMenu) {
                userMenu.click(); // OtevÅ™e uÅ¾ivatelskÃ© menu
                setTimeout(() => {
                    let emailElement = document.querySelector(".clYaW"); // HledÃ¡ email uÅ¾ivatele
                    if (emailElement) {
                        userEmail = emailElement.textContent.trim();
                        console.log("Meiro Better WF: Nalezen email uÅ¾ivatele:", userEmail);
                        fillForm(); // VyplnÃ­ formulÃ¡Å™
                    }
                }, 500);
            }
        }

        function simulateReactSelect(input, value) {
            const nativeInputValueSetter = Object.getOwnPropertyDescriptor(window.HTMLInputElement.prototype, "value").set;
            nativeInputValueSetter.call(input, value);
            input.dispatchEvent(new Event("input", { bubbles: true }));
            input.dispatchEvent(new Event("change", { bubbles: true }));
        }

        function fillForm() {
            if (!userEmail) {
                console.log("Meiro Better WF: ÄŒekÃ¡m na zÃ­skÃ¡nÃ­ emailu uÅ¾ivatele...");
                return;
            }

            console.log("Meiro Better WF: VyplÅˆuji email:", userEmail);

            // NajÃ­t emailovÃ½ select field
            let emailContainer = document.querySelector("[data-testid='send-test-emails-select']");
            if (emailContainer) {
                let emailInput = emailContainer.querySelector(".react-select-redux-field__input input");
                if (emailInput && emailInput.value === "") {
                    console.log("Meiro Better WF: KlikÃ¡m na emailovÃ½ input...");
                    emailInput.focus();
                    simulateReactSelect(emailInput, userEmail);

                    setTimeout(() => {
                        let dropdownMenu = document.querySelector(".react-select-redux-field__menu");
                        if (dropdownMenu) {
                            let addEmailOption = dropdownMenu.querySelector("[data-testid='select-field-option']");
                            if (addEmailOption && addEmailOption.textContent.includes(userEmail)) {
                                console.log("Meiro Better WF: KlikÃ¡m na moÅ¾nost pÅ™idÃ¡nÃ­ emailu:", userEmail);
                                addEmailOption.click();
                            }
                        }
                    }, 500);
                }
            } else {
                console.log("Meiro Better WF: EmailovÃ½ input nenalezen.");
            }

            // NajÃ­t input pro Profile ID a sprÃ¡vnÄ› ho vyplnit
            let profileInput = document.querySelector("input[data-testid='send-test-emails-profile-id']");
            if (profileInput && profileInput.value !== profileIDToFill) {
                console.log("Meiro Better WF: VyplÅˆuji Profile ID...");
                simulateReactSelect(profileInput, profileIDToFill);
            }
        }

        // Po naÄtenÃ­ strÃ¡nky zkusit zÃ­skat email
        setTimeout(getUserEmail, 1000);

        // Improved interval with max attempts to prevent infinite polling
        let attempts = 0;
        let checkInterval = setInterval(() => {
            attempts++;
            fillForm();
            if (document.querySelector(".react-select-redux-field__multi-value") &&
                document.querySelector("input[data-testid='send-test-emails-profile-id']").value === profileIDToFill) {
                clearInterval(checkInterval);
                console.log("Meiro Better WF: FormulÃ¡Å™ ÃºspÄ›Å¡nÄ› vyplnÄ›n.");
            } else if (attempts > 30) { // Stop after 30 seconds
                clearInterval(checkInterval);
                console.log("Meiro Better WF: Timeout pÅ™i vyplÅˆovÃ¡nÃ­ formulÃ¡Å™e.");
            }
        }, 1000);
        activeIntervals.push(checkInterval);
    }

    //***********************************************************

    //***********************************************************
    // Funkce pro sledovÃ¡nÃ­ textarea elementu a vÃ½poÄet velikosti obsahu editoru
    function monitorTextarea() {
        // Zkontrolujeme, zda aktuÃ¡lnÃ­ URL obsahuje poÅ¾adovanou cestu
        if (!window.location.href.includes("meiro.io/channels/emails/campaigns")) {
            console.log('ðŸ”’ Meiro Better WF: HTML size Skript nenÃ­ spuÅ¡tÄ›n, URL neodpovÃ­dÃ¡ poÅ¾adovanÃ©mu vzoru.');
            return; // Skript se nespustÃ­, pokud URL neodpovÃ­dÃ¡
        }

        console.log("ðŸ”Ž Funkce pro monitorovÃ¡nÃ­ textarea spuÅ¡tÄ›na...");

        const textareaElement = document.querySelector('textarea.ace_text-input');

        // VytvoÅ™enÃ­ novÃ©ho divu pro zobrazenÃ­ velikosti, pokud jeÅ¡tÄ› neexistuje
        let sizeDisplayElement = document.getElementById('size-display');
        if (!sizeDisplayElement) {
            sizeDisplayElement = document.createElement('div');
            sizeDisplayElement.id = 'size-display';
            sizeDisplayElement.style.position = 'fixed';
            sizeDisplayElement.style.bottom = '10px';
            sizeDisplayElement.style.right = '10px';
            sizeDisplayElement.style.padding = '10px';
            sizeDisplayElement.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            sizeDisplayElement.style.color = 'white';
            sizeDisplayElement.style.borderRadius = '5px';
            sizeDisplayElement.style.fontSize = '14px';
            sizeDisplayElement.style.zIndex = '10000';
            document.body.appendChild(sizeDisplayElement); // PÅ™idÃ¡me div na strÃ¡nku
        }

        if (textareaElement) {
            // Najdeme nejbliÅ¾Å¡Ã­ Ace Editor
            const aceEditorElement = textareaElement.closest('.ace_editor');

            if (aceEditorElement && window.ace) {
                // ZÃ­skÃ¡nÃ­ instance Ace Editoru
                const aceEditor = window.ace.edit(aceEditorElement);

                // ZÃ­skÃ¡nÃ­ kompletnÃ­ho obsahu editoru
                const textContent = aceEditor.getValue();

                if (textContent.length > 0) {
                    // PÅ™evod textu na bajty pomocÃ­ TextEncoder (UTF-8) s fallback
                    let sizeInBytes;
                    try {
                        sizeInBytes = new TextEncoder().encode(textContent).length;
                    } catch (e) {
                        // Fallback pro starÅ¡Ã­ prohlÃ­Å¾eÄe
                        sizeInBytes = textContent.length * 2; // Aproximace pro UTF-8
                    }
                    const sizeInKB = (sizeInBytes / 1024).toFixed(2);
                    console.log(`âœ…  Meiro Better WF: Ace Editor nalezen. Velikost obsahu: ${sizeInKB} KB`);

                    // ZobrazenÃ­ velikosti v divu
                    sizeDisplayElement.innerHTML = `Velikost obsahu: ${sizeInKB} KB`;
                } else {
                    console.log('âœ…  Meiro Better WF: Ace Editor nalezen, ale obsah je prÃ¡zdnÃ½.');
                    sizeDisplayElement.innerHTML = "Velikost obsahu: 0 KB";
                }
            } else {
                console.log('âš ï¸  Meiro Better WF: Ace Editor nebyl nalezen, poÄÃ­tÃ¡m jen textarea.');
                const textContent = textareaElement.value;
                let sizeInBytes;
                try {
                    sizeInBytes = new TextEncoder().encode(textContent).length;
                } catch (e) {
                    sizeInBytes = textContent.length * 2;
                }
                const sizeInKB = (sizeInBytes / 1024).toFixed(2);
                console.log(`âœ…  Meiro Better WF: Velikost obsahu textarea: ${sizeInKB} KB`);

                // ZobrazenÃ­ velikosti v divu
                sizeDisplayElement.innerHTML = `Velikost obsahu: ${sizeInKB} KB`;
            }
        } else {
            console.log('âŒ  Meiro Better WF: Textarea nenalezen.');
            sizeDisplayElement.innerHTML = "Velikost obsahu: 0 KB";
        }
    }

    // Start monitoring with cleanup tracking
    const monitorInterval = setInterval(monitorTextarea, 3000);
    activeIntervals.push(monitorInterval);

    //********************************** Funkce pro aplikaci stylÅ¯ **********************************
    // Funkce pro pÅ™idÃ¡nÃ­ stylÅ¯ do hlaviÄky strÃ¡nky
    function addStyles() {
        console.log("Meiro Better WF: PÅ™idÃ¡vÃ¡m styly...");

        var style = document.createElement('style');
        style.type = 'text/css';
        style.innerHTML = `
        @media (max-width: 1250px) {
            .dyn_width_small div div section{
                max-width: 90% !important;
                width: 90% !important;
            }
        }

        @media (min-width: 1320px) {
            .dyn_width_large div div section{
                min-width: 95% !important;
            }
        }

        .max-width-92 { min-width: 92% !important; }
        .max-width-89 { min-width: 89% !important; }

        .flex-730 { flex: 0 0 730px; }
        .flex-500 { flex: 0 0 500px; }
        .TextInput_wrapper__6i7yo .TextInput_row__J20k3 .TextInput_warningWrapper__20GtL {
            min-width: 450px !important;
        }
        .width-auto-content { width: -webkit-fill-available; max-width: -webkit-fill-available; }
        .EmailEditor_emailEditor__18vqj { width: auto !important; }
        .wrapper { max-width: 1600px !important; }
        .files .scrollable.files-content {
            max-height: 350px !important;
        }
        /*aktivni*/
        .width-fill-content { width: -webkit-fill-available !important; max-width: -webkit-fill-available !important; flex: auto !important;}
        .width-auto { width: auto !important;}
        .flex-auto { flex: auto !important; }
    `;
        document.head.appendChild(style);
        console.log("Meiro Better WF: Styly ÃºspÄ›Å¡nÄ› pÅ™idÃ¡ny.");
    }

    // Funkce pro pÅ™idÃ¡nÃ­ novÃ½ch tÅ™Ã­d
    function addClasses() {
        console.log("Meiro Better WF: HledÃ¡m prvky pro pÅ™idÃ¡nÃ­ tÅ™Ã­d...");

        const classMap = {
            'content-wrap': ['width-fill-content'],
            'sm6GI': ['width-fill-content'], // segments
            '_9rPmH': ['width-fill-content'], // segments
            'ENn0I': ['width-fill-content'], // channels hlaviÄka
            '_748bX': ['width-fill-content'], // popup-banners hlaviÄka
            'yHmIT': ['width-fill-content'], // channels/emails/campaigns hlaviÄka
            'box-border': ['width-auto']
        };

        let elementsUpdated = 0;

        Object.entries(classMap).forEach(([targetClass, newClasses]) => {
            document.querySelectorAll('.' + targetClass).forEach(element => {
                newClasses.forEach(newClass => {
                    if (!element.classList.contains(newClass)) {
                        element.classList.add(newClass);
                        elementsUpdated++;
                    }
                });
            });
        });

        console.log(`Meiro Better WF: PÅ™idÃ¡ny tÅ™Ã­dy u ${elementsUpdated} prvkÅ¯.`);
    }

    // ZajiÅ¡tÄ›nÃ­, Å¾e skript bÄ›Å¾Ã­ po naÄtenÃ­ strÃ¡nky
    (function init() {
        console.log("Meiro Better WF: SpouÅ¡tÃ­m skript...");

        if (document.readyState === "loading") {
            document.addEventListener("DOMContentLoaded", () => {
                console.log("Meiro Better WF: DOMContentLoaded detekovÃ¡no");
                addStyles();
                addClasses();
            });
        } else {
            console.log("Meiro Better WF: Dokument je jiÅ¾ naÄten, provÃ¡dÃ­m akce");
            addStyles();
            addClasses();
        }
    })();

    // Sleduje zmÄ›ny v DOM a aplikuje tÅ™Ã­dy na novÄ› pÅ™idanÃ© prvky
    const observer2 = new MutationObserver(() => {
        console.log("Meiro Better WF: DetekovÃ¡na zmÄ›na v DOM, znovu aplikuji tÅ™Ã­dy...");
        addClasses();
    });

    observer2.observe(document.body, { childList: true, subtree: true });

    //***********************************************************
    // ******************** CTA DELETE button v popupu, vÅ¾dy aktivnÃ­ pro "enter" **************************
    (function() {
        let intervalId = null;

        function focusDeleteButton() {
            const deleteButton = document.querySelector('[data-testid="confirm-modal-delete-button"]');
            if (deleteButton) {
                deleteButton.focus();
                console.log('Meiro Better WF: TlaÄÃ­tko Delete bylo fokusovÃ¡no.');

                // Stop interval after successful focus
                if (intervalId) {
                    clearInterval(intervalId);
                    const index = activeIntervals.indexOf(intervalId);
                    if (index > -1) activeIntervals.splice(index, 1);
                    intervalId = null;
                }
            }
        }

        function tryFocusDeleteButton() {
            if (intervalId) {
                clearInterval(intervalId);
                const index = activeIntervals.indexOf(intervalId);
                if (index > -1) activeIntervals.splice(index, 1);
            }

            intervalId = setInterval(focusDeleteButton, 50);
            activeIntervals.push(intervalId);

            // Stop after 2 seconds if unsuccessful
            setTimeout(() => {
                if (intervalId) {
                    clearInterval(intervalId);
                    const index = activeIntervals.indexOf(intervalId);
                    if (index > -1) activeIntervals.splice(index, 1);
                    intervalId = null;
                }
            }, 2000);
        }

        const modalObserver = new MutationObserver((mutations) => {
            for (let mutation of mutations) {
                for (let node of mutation.addedNodes) {
                    if (node.nodeType === 1 && node.querySelector('[data-testid="confirm-modal-delete-button"]')) {
                        tryFocusDeleteButton();
                    }
                }
            }
        });

        modalObserver.observe(document.body, { childList: true, subtree: true });
    })();
})();
